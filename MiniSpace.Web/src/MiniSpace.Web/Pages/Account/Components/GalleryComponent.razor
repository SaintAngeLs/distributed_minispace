@page "/student-profile"
@using MiniSpace.Web.DTO.Types
@using MiniSpace.Web.DTO
@using MiniSpace.Web.Areas.MediaFiles
@using MiniSpace.Web.Areas.Students
@using System.IO
@using Microsoft.AspNetCore.Components.Forms
@inject IMediaFilesService MediaFilesService
@inject IIdentityService IdentityService
@inject IStudentsService StudentsService
@inject NavigationManager NavigationManager
@inject IDialogService DialogService
@inject IJSRuntime JSRuntime
@using MudBlazor
@using Cropper.Blazor.Models

<MudDialogProvider/>
<div>
    <MudText Typo="Typo.h6" GutterBottom="true">Gallery</MudText>
    @if (isLoading)
    {
        <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
    }
    else
    {
        <MudGrid>
            <MudItem xs="12">
                <MudText Typo="Typo.h6" GutterBottom="true">Current Banner</MudText>
                @if (!string.IsNullOrEmpty(studentDto.BannerUrl))
                {
                    <MudCard>
                        <MudCardMedia Image="@studentDto.BannerUrl" Alt="Banner image" />
                    </MudCard>
                }
                <div class="image-upload-container">
                    <InputFile OnChange="OnInputFileChange" Accept=".jpg,.jpeg,.png" />
                    @if (bannerFile != null)
                    {
                        <MudText> <MudIcon Icon="@Icons.Material.Filled.Attachment" /> @bannerFile.Name </MudText>
                    }
                    else
                    {
                        <MudText><MudIcon Icon="@Icons.Material.Filled.Attachment" /> No Files Selected</MudText>
                    }
                </div>
                @if (!string.IsNullOrEmpty(croppedBannerBase64))
                {
                    <div class="cropped-banner-preview">
                        <MudCard>
                            <MudCardMedia Image="@croppedBannerBase64" Alt="Cropped Banner Preview" />
                        </MudCard>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveCroppedBanner">Save Banner Image</MudButton>
                    </div>
                }
            </MudItem>

            <MudItem xs="12">
                <MudText Typo="Typo.h6" GutterBottom="true">Gallery Images</MudText>
                <div class="spotlight-group">
                    @foreach (var imageUrl in studentDto.GalleryOfImageUrls)
                    {
                        <MudItem xs="12" sm="6" md="4">
                            <a class="spotlight" href="@imageUrl">
                                <MudCard>
                                    <MudCardMedia Image="@imageUrl" Alt="Gallery image" />
                                </MudCard>
                            </a>
                        </MudItem>
                    }
                </div>
                <div class="image-upload-container">
                    <InputFile OnChange="OnGalleryFilesChanged" Accept=".jpg,.jpeg,.png" Multiple />
                    @if (galleryFiles != null && galleryFiles.Any())
                    {
                        <MudText> <MudIcon Icon="@Icons.Material.Filled.Attachment" /> @galleryFiles.Count() files selected </MudText>
                    }
                    else
                    {
                        <MudText><MudIcon Icon="@Icons.Material.Filled.Attachment" /> No Files Selected</MudText>
                    }
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="UploadGalleryImagesAsync">Upload to Gallery</MudButton>
                </div>
            </MudItem>
        </MudGrid>
    }
</div>

@if (bannerFile != null)
{
    <div class="modal is-active">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Crop Image</p>
                <button class="delete" aria-label="close" @onclick="CloseCropper"></button>
            </header>
            <section class="modal-card-body" style="overflow-x: hidden">
                <CropperComponent Class="cropper-container"
                                  ErrorLoadImageClass="cropper-error-load"
                                  @ref="cropperComponent"
                           
                                  Src="@bannerFileSrc"
                                  Options="new Options { AspectRatio = 1.7777777777777777m, ViewMode = ViewMode.Vm1 }" />
            </section>
            <footer class="modal-card-foot">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="DoneCrop">Done</MudButton>
                <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="CloseCropper">Cancel</MudButton>
            </footer>
        </div>
    </div>
}

@code {
    private bool isLoading = true;
    private StudentDto studentDto = new();
    private IList<IBrowserFile> galleryFiles = new List<IBrowserFile>();
    private IBrowserFile bannerFile;
    private string bannerFileSrc;
    private string croppedBannerBase64;
    private CropperComponent cropperComponent;
    private bool showCropper = false;
    private const long maxFileSize = 10 * 1024 * 1024;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        try
        {
            await IdentityService.InitializeAuthenticationState();
            if (IdentityService.IsAuthenticated)
            {
                var studentId = IdentityService.GetCurrentUserId();
                studentDto = await StudentsService.GetStudentAsync(studentId);
            }
            else
            {
                NavigationManager.NavigateTo("/login");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in OnInitializedAsync: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnInputFileChange(InputFileChangeEventArgs args)
    {
        var file = args.File;
        if (file != null)
        {
            var buffer = new byte[file.Size];
            await file.OpenReadStream().ReadAsync(buffer);
            bannerFile = file;
            bannerFileSrc = $"data:{file.ContentType};base64,{Convert.ToBase64String(buffer)}";
            showCropper = true;
            StateHasChanged();
        }
    }

    private async Task OnGalleryFilesChanged(InputFileChangeEventArgs args)
    {
        galleryFiles = args.GetMultipleFiles().ToList();
        StateHasChanged();
    }

    private async Task DoneCrop()
    {
        var croppedImage = await cropperComponent.GetCroppedCanvasDataURLAsync(new GetCroppedCanvasOptions());
        croppedBannerBase64 = croppedImage;
        showCropper = false;
        StateHasChanged();
    }

    private async Task SaveCroppedBanner()
    {
        var base64Content = croppedBannerBase64.Split(',')[1]; // Remove data URL prefix
        var response = await MediaFilesService.UploadMediaFileAsync(IdentityService.GetCurrentUserId(),
            MediaFileContextType.StudentBannerImage.ToString(), IdentityService.GetCurrentUserId(),
            "banner.jpg", "image/jpeg", base64Content);
        if (response.Content != null && !string.IsNullOrEmpty(response.Content.FileUrl))
        {
            studentDto.BannerUrl = response.Content.FileUrl;
            croppedBannerBase64 = null;
            StateHasChanged();
        }
    }

    private void CloseCropper()
    {
        showCropper = false;
        bannerFile = null;
        bannerFileSrc = null;
        StateHasChanged();
    }

    private async Task UploadGalleryImagesAsync()
    {
        if (galleryFiles != null && galleryFiles.Count > 0)
        {
            foreach (var file in galleryFiles)
            {
                var stream = file.OpenReadStream(maxFileSize);
                byte[] bytes = await ReadFully(stream);
                var base64Content = Convert.ToBase64String(bytes);
                var response = await MediaFilesService.UploadMediaFileAsync(IdentityService.GetCurrentUserId(),
                    MediaFileContextType.StudentGalleryImage.ToString(), IdentityService.GetCurrentUserId(),
                    file.Name, file.ContentType, base64Content);
                if (response.Content != null && !string.IsNullOrEmpty(response.Content.FileUrl))
                {
                    studentDto.GalleryOfImageUrls = studentDto.GalleryOfImageUrls.Append(response.Content.FileUrl).ToList();
                }
                stream.Close();
            }
            StateHasChanged();
        }
    }

    private static async Task<byte[]> ReadFully(Stream input)
    {
        byte[] buffer = new byte[16 * 1024];
        using (MemoryStream ms = new MemoryStream())
        {
            int read;
            while ((read = await input.ReadAsync(buffer, 0, buffer.Length)) > 0)
            {
                ms.Write(buffer, 0, read);
            }
            return ms.ToArray();
        }
    }

    // private void OnCropEvent(JSEventData<CropEvent> cropEvent)
    // {
    //     // Console.WriteLine($"CropEvent: {cropEvent.Detail?.ActionEvent}");
    // }
    //
    // private void OnZoomEvent(JSEventData<ZoomEvent> zoomEvent)
    // {
    //     // Console.WriteLine($"ZoomEvent: OldRatio: {zoomEvent.Detail?.OldRatio}, Ratio: {zoomEvent.Detail?.Ratio}");
    // }
}
<style>
    @@import url("https://fastly.jsdelivr.net/npm/bulma@0.9.0/css/bulma.min.css");
</style>
